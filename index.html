<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Neon Drift: LOTF Racer</title>
<style>
  :root{
    --bg:#0f1a34; --panel:#121f40; --accent:#00e5ff; --accent2:#ff2bd6; --accent3:#73ffb2; --text:#eaf6ff;
    --good:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #ui{
    position:fixed; inset:0 0 auto 0; display:flex; gap:10px; align-items:center; padding:10px 12px;
    background:linear-gradient(to bottom,rgba(255,255,255,.08),rgba(255,255,255,0));
    user-select:none; pointer-events:none; z-index:10;
  }
  .pill{pointer-events:auto; background:rgba(18,31,64,.75); border:1px solid #2a3b6a; border-radius:12px; padding:8px 10px; display:flex; gap:8px; align-items:center}
  .stat{font-weight:800; letter-spacing:.3px}
  .btn{pointer-events:auto; background:var(--accent); border:none; color:#001018; font-weight:900; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn.ghost{background:transparent;border:2px solid var(--accent);color:var(--text)}
  #overlay, #review, #settings{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,10,30,.45); backdrop-filter: blur(4px); z-index:20;}
  .card{width:min(980px,94vw); max-height:84vh; overflow:auto; background:var(--panel); border:1px solid #2a3b6a; border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .meta{display:flex;gap:10px;align-items:center;opacity:.95}
  .timer{margin-left:auto;font-weight:900}
  .answers{display:grid; gap:10px; margin-top:10px}
  .answers button{border:none;border-radius:12px; padding:14px; font-weight:800; cursor:pointer}
  .choice{background:rgba(18,31,64,.9); border:2px solid #2a3b6a; color:#e7f6ff}
  #centerMsg{
    position:fixed; left:50%; top:14%; transform:translateX(-50%); font-weight:900; letter-spacing:.5px;
    background:rgba(18,31,64,.9); border:1px solid #2a3b6a; border-radius:12px; padding:8px 12px; display:none; z-index:15;
  }
  #pad{
    position:fixed; right:14px; bottom:14px; display:grid; grid-template-columns:78px 78px; gap:10px;
    opacity:.95; user-select:none; z-index:10;
  }
  .ctl{background:rgba(18,31,64,.9); border:2px solid #2a3b6a; border-radius:14px; color:#cfe6ff; font-size:18px; font-weight:900; display:flex; align-items:center; justify-content:center; height:64px; cursor:pointer}
  @media (min-width:880px){ #pad{display:none} }
  #toast{position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#0d1a39; color:#bfe6ff; border:1px solid #2a3b6a; border-radius:12px; padding:8px 12px; display:none; z-index:15;}
  .qrow{border:1px solid #2a3b6a;border-radius:12px;padding:10px;margin:8px 0;background:#10224d}
  .qrow b{color:#d7ecff}
  .correctTag{font-weight:700;color:#22c55e;margin-left:6px}
  .wrongTag{font-weight:700;color:#ef4444;margin-left:6px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:8px 10px;text-align:left}
  tr.entry{background:#10224d;border-radius:12px}
</style>
</head>
<body>
<div id="ui">
  <div class="pill"><span>Time:</span> <span class="stat" id="time">05:00</span></div>
  <div class="pill"><span>Speed:</span> <span class="stat" id="speed">0</span></div>
  <div class="pill"><span>Distance:</span> <span class="stat"><span id="distM">0</span> m | <span id="distKm">0.00</span> km</span></div>
  <div class="pill"><span>Score:</span> <span class="stat" id="score">0</span></div>
  <div class="pill"><span>Correct:</span> <span class="stat" id="correct">0</span></div>
  <div class="pill"><span>Merits:</span> <span class="stat" id="merits">0</span></div>
  <button class="btn ghost" id="pauseBtn" style="margin-left:auto">Pause</button>
  <button class="btn ghost" id="lbBtn">üèÜ Leaderboard</button>
  <button class="btn ghost" id="settingsBtn">‚öôÔ∏è Settings</button>
  <button class="btn" id="restartBtn">Restart</button>
</div>

<div id="centerMsg"></div>
<div id="toast"></div>

<!-- Quiz Overlay -->
<div id="overlay">
  <div class="card">
    <div class="meta">
      <h2 style="margin:0">Quiz: <em>Lord of the Flies</em></h2>
      <div class="timer">‚è±Ô∏è <span id="tLeft">10</span>s</div>
    </div>
    <div id="qText" style="margin-top:6px">Question here‚Ä¶</div>
    <div class="answers" id="answers"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn ghost" id="skip">Skip</button>
      <button class="btn" id="resume">Resume</button>
    </div>
  </div>
</div>

<!-- Review / Leaderboard -->
<div id="review">
  <div class="card">
    <div class="meta" style="margin-bottom:8px">
      <h2 style="margin:0">Session Review (5 minutes)</h2>
      <div style="margin-left:auto;font-weight:900">Merits: <span id="finalMerits">0</span></div>
    </div>
    <h3 style="margin:6px 0">Your Answers</h3>
    <div id="reviewList"></div>
    <h3 style="margin:14px 0 6px">Leaderboard (saved on this device)</h3>
    <div style="display:flex;gap:6px;align-items:center;margin:6px 0">
      <input id="playerName" placeholder="Enter name/initials" style="flex:1; padding:10px;border-radius:10px;border:1px solid #2a3b6a;background:#10224d;color:#e7f6ff">
      <input id="playerClass" placeholder="Class (e.g., 10.2)" style="width:140px; padding:10px;border-radius:10px;border:1px solid #2a3b6a;background:#10224d;color:#e7f6ff">
      <button class="btn" id="saveScore">Save Score</button>
    </div>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Class</th><th>Score</th><th>Correct</th><th>Distance</th><th>Merits</th></tr></thead>
      <tbody id="lbBody"></tbody>
    </table>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="playAgain">Play Again</button>
      <button class="btn ghost" id="closeReview">Close</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="settings">
  <div class="card">
    <div class="meta" style="margin-bottom:10px"><h2 style="margin:0">Settings</h2></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <label style="flex:1; min-width:220px">
        <div style="opacity:.85;margin-bottom:6px">Default Player Name</div>
        <input id="defName" placeholder="Player" style="width:100%; padding:10px;border-radius:10px;border:1px solid #2a3b6a;background:#10224d;color:#e7f6ff">
      </label>
      <label style="width:220px">
        <div style="opacity:.85;margin-bottom:6px">Default Class</div>
        <input id="defClass" placeholder="10.1" style="width:100%; padding:10px;border-radius:10px;border:1px solid #2a3b6a;background:#10224d;color:#e7f6ff">
      </label>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" id="saveSettings">Save</button>
      <button class="btn ghost" id="closeSettings">Close</button>
    </div>
  </div>
</div>

<!-- Mobile controls -->
<div id="pad" aria-label="controls">
  <div class="ctl" id="left">‚óÄ</div>
  <div class="ctl" id="right">‚ñ∂</div>
  <div class="ctl" id="boost">BOOST</div>
  <div class="ctl" id="brake">BRAKE</div>
</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
const DPR = Math.min(2, window.devicePixelRatio || 1);

/* ---------- Scene / Camera / Renderer (lighter) ---------- */
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x1a2a55, 0.012);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 2200);
camera.position.set(0, 2.6, 6);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setClearColor(0x10224d, 1);
renderer.setPixelRatio(DPR);
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* ---------- Lighting (brighter) ---------- */
scene.add(new THREE.HemisphereLight(0x8fd9ff, 0x101a33, 1.0));
const dir  = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(6,10,4); scene.add(dir);
const fill = new THREE.PointLight(0x89f0ff, 0.9, 80); fill.position.set(0,6,0); scene.add(fill);

/* ---------- Track ---------- */
const TRACK_WIDTH=8, SEG_LEN=40, SEG_COUNT=14, WALL_H=5, FLOOR_Y=0;
const neonMat = (c)=> new THREE.MeshStandardMaterial({ color:c, metalness:0.25, roughness:0.25, emissive:c, emissiveIntensity:0.6 });
const darkMat = new THREE.MeshStandardMaterial({color:0x1a2a55, metalness:0.15, roughness:0.8});
const glowLaneMat = (c)=> new THREE.MeshBasicMaterial({color:c});

function makeGraffitiTexture(text="Mr Samuels ENG HL Grade 10 TM"){
  const c = document.createElement("canvas"); c.width=2048; c.height=512;
  const g=c.getContext("2d");
  g.fillStyle="#142a5a"; g.fillRect(0,0,c.width,c.height);
  g.fillStyle="#183367"; for(let x=0;x<c.width;x+=64){ for(let y=0;y<c.height;y+=32){ g.fillRect(x + (y%64?0:32), y, 58, 26); } }
  g.save(); g.translate(c.width/2, c.height/2 + 60); g.rotate(-0.035);
  g.font="900 240px Impact, Arial Black, sans-serif";
  g.fillStyle="#203d86"; g.shadowColor="#00d2ff"; g.shadowBlur=28; g.textAlign="center"; g.fillText(text, 0, 0);
  g.shadowBlur=0; g.lineWidth=14; g.strokeStyle="#78e0ff"; g.strokeText(text, 0, 0);
  const grd=g.createLinearGradient(-500,0,500,0); grd.addColorStop(0,"#d0f1ff"); grd.addColorStop(1,"#7fd3ff");
  g.fillStyle=grd; g.fillText(text, 0, 0); g.restore();
  const tex=new THREE.CanvasTexture(c); tex.wrapS=tex.wrapT=THREE.RepeatWrapping; tex.repeat.set(1,1); tex.anisotropy=16;
  return tex;
}
const wallTex = makeGraffitiTexture();

/* Segments */
const segments=[], laneStrips=[];
const floorGeo = new THREE.PlaneGeometry(TRACK_WIDTH, SEG_LEN);
const wallGeo  = new THREE.PlaneGeometry(SEG_LEN, WALL_H);
const stripGeo = new THREE.PlaneGeometry(TRACK_WIDTH, 0.1);

for(let i=0;i<SEG_COUNT;i++){
  const group=new THREE.Group();
  const floor=new THREE.Mesh(floorGeo, darkMat); floor.rotation.x=-Math.PI/2; floor.position.set(0,FLOOR_Y,-i*SEG_LEN); group.add(floor);
  const matWall=new THREE.MeshStandardMaterial({color:0xffffff, map:wallTex, metalness:0.1, roughness:0.8, emissive:0x1a2a55, emissiveIntensity:0.35});
  const left=new THREE.Mesh(wallGeo, matWall); left.rotation.y=Math.PI/2; left.position.set(-TRACK_WIDTH/2, WALL_H/2, -i*SEG_LEN);
  const right=new THREE.Mesh(wallGeo, matWall); right.rotation.y=-Math.PI/2; right.position.set( TRACK_WIDTH/2, WALL_H/2, -i*SEG_LEN);
  group.add(left,right);
  for(let s=0;s<SEG_LEN;s+=2){
    const strip=new THREE.Mesh(stripGeo, glowLaneMat((s%4===0)?0xffffff:0x00e5ff));
    strip.rotation.x=-Math.PI/2; strip.position.set(0,FLOOR_Y+0.01,-i*SEG_LEN - s);
    group.add(strip); laneStrips.push(strip);
  }
  segments.push(group); scene.add(group);
}

/* Billboards */
function addBillboard(z){
  const m=new THREE.Mesh(new THREE.PlaneGeometry(6,2), new THREE.MeshStandardMaterial({map:wallTex, emissive:0x2a4ea0, emissiveIntensity:0.65}));
  m.position.set((Math.random()<0.5?-1:1)*(TRACK_WIDTH/2-0.6),1.4,z); m.rotation.y=(m.position.x<0)?Math.PI/2:-Math.PI/2; scene.add(m); return m;
}
const billboards=[]; for(let i=0;i<8;i++) billboards.push(addBillboard(-i*SEG_LEN*1.7 - 20));

/* Curve */
let curveAmp=2.0, curveFreq=0.012, curvePhase=0;
const curveX = z => curveAmp * Math.sin(curveFreq * (z + curvePhase));

/* Car (no bob, no sway) */
const car=new THREE.Group();
const body=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.35,3.0), new THREE.MeshStandardMaterial({color:0xd6dde6, metalness:0.7, roughness:0.25}));
body.position.y=0.45; car.add(body);
const hood=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.2,1.1), new THREE.MeshStandardMaterial({color:0xb9c4d1, metalness:0.7, roughness:0.25})); hood.position.set(0,0.6,0.9); car.add(hood);
const canopy=new THREE.Mesh(new THREE.BoxGeometry(1.2,0.32,0.9), new THREE.MeshStandardMaterial({color:0x293a66, emissive:0x293a66, emissiveIntensity:0.3}));
canopy.position.set(0,0.7,0.2); car.add(canopy);
const barGeo=new THREE.BoxGeometry(0.15,0.15,2.6);
car.add(new THREE.Mesh(barGeo, neonMat(0x00e5ff))).position.set(-0.9,0.35,0);
const rb=new THREE.Mesh(barGeo, neonMat(0xff2bd6)); rb.position.set(0.9,0.35,0); car.add(rb);
const wheelGeo=new THREE.CylinderGeometry(0.45,0.45,0.18,18);
const wheelMat=new THREE.MeshStandardMaterial({color:0x0c111d, emissive:0x00e5ff, emissiveIntensity:0.25, metalness:0.6, roughness:0.4});
function wheel(x,z){ const w=new THREE.Mesh(wheelGeo,wheelMat); w.rotation.z=Math.PI/2; w.position.set(x,0.3,z);
  const glow=new THREE.Mesh(new THREE.TorusGeometry(0.45,0.05,12,24), new THREE.MeshBasicMaterial({color:0x00e5ff})); glow.position.set(x,0.3,z); car.add(w,glow);
}
wheel(-0.85,1.0); wheel(0.85,1.0); wheel(-0.85,-1.0); wheel(0.85,-1.0);
car.position.set(0,0.22,4); scene.add(car);

/* Items (no coins at all) */
const boosts=[], obstacles=[], speedups=[], ramps=[];
const boostGeo=new THREE.BoxGeometry(TRACK_WIDTH*0.7,0.05,2);
const boostMat=new THREE.MeshBasicMaterial({color:0x73ffb2});
const obstacleGeo=new THREE.BoxGeometry(1.8,1.2,1.4);
const obstacleTex=(()=>{ const c=document.createElement("canvas"); c.width=512;c.height=256; const g=c.getContext("2d");
  g.fillStyle="#173164"; g.fillRect(0,0,c.width,c.height); g.strokeStyle="#79cfff"; g.lineWidth=8; g.strokeRect(6,6,c.width-12,c.height-12);
  g.font="bold 34px Inter, Arial"; g.fillStyle="#e7f6ff"; g.textAlign="center"; g.shadowColor="#00e5ff"; g.shadowBlur=12;
  g.fillText("Mr Samuels ‚Äì Grade 10 English ‚Ñ¢", c.width/2, c.height/2 + 12);
  const t=new THREE.CanvasTexture(c); t.anisotropy=8; return t; })();
const obstacleMat=new THREE.MeshStandardMaterial({color:0xffffff, map:obstacleTex, metalness:0.2, roughness:0.6, emissive:0x1b356e, emissiveIntensity:0.35});
const speedupGeo=new THREE.ConeGeometry(0.35,0.9,16);
const speedupMat=new THREE.MeshStandardMaterial({color:0x73fffb, emissive:0x00e5ff, emissiveIntensity:0.9});
function rampMesh(){ const geom=new THREE.BoxGeometry(2.4,0.2,2.6);
  const mat=new THREE.MeshStandardMaterial({color:0x3a64ff, emissive:0x3a64ff, emissiveIntensity:0.45});
  const ramp=new THREE.Mesh(geom,mat); const slope=new THREE.Mesh(new THREE.BoxGeometry(2.4,0.1,2.6), new THREE.MeshStandardMaterial({color:0x00e5ff, emissive:0x00e5ff, emissiveIntensity:0.75}));
  slope.position.y=0.16; slope.rotation.x=-Math.PI*0.12; ramp.add(slope); return ramp;
}

/* Tunnel portals (2‚Äì3 choices) */
const tunnels=[];
const portalGeo=new THREE.TorusGeometry(1.3,0.18,12,40,Math.PI);
const portalMats={easy:neonMat(0x66ffea), standard:neonMat(0x00e5ff), hard:neonMat(0xff7a00)};
const lanes=[-2.6,0,2.6];

function makeTunnelGroup(z){
  const g=new THREE.Group(); g.userData={type:"tunnels", used:false};
  const count=(Math.random()<0.5)?2:3;
  const idxs=[0,1,2].sort(()=>Math.random()-0.5).slice(0,count).sort((a,b)=>a-b);
  const pool=["easy","standard","hard"].sort(()=>Math.random()-0.5);
  for(let i=0;i<count;i++){
    const pr=pool[i]; const p=new THREE.Mesh(portalGeo, portalMats[pr]);
    p.rotation.x=Math.PI/2; p.position.set(lanes[idxs[i]],1.4,z);
    p.userData={type:"portal", profile:pr, baseX:p.position.x};
    const plate=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.08,0.6), new THREE.MeshStandardMaterial({color:0x12224c, emissive:0x12224c}));
    plate.position.set(0,-0.9,0); p.add(plate); g.add(p);
  }
  scene.add(g); g.position.z=z; tunnels.push(g); return g;
}

/* Spawners */
const spawnPoolZ = -SEG_COUNT*SEG_LEN + 10;
const laneX = ()=> lanes[(Math.random()*lanes.length)|0];

for (let i=0;i<5;i++){ const m=new THREE.Mesh(boostGeo,boostMat); m.position.set(0,0.03, spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN); m.rotation.x=-Math.PI/2; m.userData={type:"boost"}; scene.add(m); boosts.push(m); }
for (let i=0;i<8;i++){ const m=new THREE.Mesh(obstacleGeo,obstacleMat); m.position.set(laneX(),0.6, spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN); m.userData={type:"obstacle", baseX:m.position.x, phase:Math.random()*Math.PI*2, amp:0.35+Math.random()*0.35}; scene.add(m); obstacles.push(m); }
for (let i=0;i<6;i++){ const m=new THREE.Mesh(speedupGeo,speedupMat); m.position.set(laneX(),0.5, spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN); m.rotation.x=Math.PI; m.userData={type:"speedup", baseX:m.position.x}; scene.add(m); speedups.push(m); }
for (let i=0;i<5;i++){ const m=rampMesh(); m.position.set(laneX(),0.1, spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN); m.userData={type:"ramp", baseX:m.position.x}; scene.add(m); ramps.push(m); }
for (let i=0;i<3;i++) makeTunnelGroup(spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN);

/* Drones */
const drones=[];
function spawnDrone(){
  const g=new THREE.Group();
  g.add(new THREE.Mesh(new THREE.SphereGeometry(0.25,16,12), new THREE.MeshStandardMaterial({color:0xffffff, emissive:0x73d9ff, emissiveIntensity:0.9})));
  g.add(new THREE.PointLight(0x73d9ff, 1.0, 8));
  g.position.set((Math.random()*2-1)*5, 3+Math.random()*2, -SEG_LEN*SEG_COUNT + Math.random()*SEG_LEN*SEG_COUNT);
  g.userData={type:"drone", vx:(Math.random()<0.5?-1:1)*(0.5+Math.random()), life:6+Math.random()*6};
  scene.add(g); drones.push(g);
}
setInterval(()=>{ if(drones.length<3) spawnDrone(); }, 3000);

/* ---------- Game state ---------- */
let running=true, pausedForQuiz=false, tPrev=performance.now();
let speed=12, targetSpeed=16, maxSpeed=28, minSpeed=6;
let dist=0, baseScore=0, bonusScore=0, score=0;
let boostTimer=0, speedupTimer=0;
let correct=0, merits=0, wallHitCooldown=0;

/* Lane snap */
let laneIndex=1;                   // 0:left, 1:middle, 2:right
const laneChange=(dir)=>{ laneIndex = THREE.MathUtils.clamp(laneIndex + dir, 0, 2); };
addEventListener("keydown",(e)=>{
  const k=e.key.toLowerCase();
  if(e.repeat) return;
  if(k==="arrowleft"||k==="a") laneChange(-1);
  if(k==="arrowright"||k==="d") laneChange(+1);
});
document.getElementById("left").addEventListener("pointerdown", ()=>laneChange(-1));
document.getElementById("right").addEventListener("pointerdown",()=>laneChange(+1));

/* Timer */
const SESSION_DURATION=300; let sessionLeft=SESSION_DURATION;

/* Jump physics */
let vy=0; const baseY=0.22; const gravity=-9.6; let onGround=true;

/* Profiles */
let profile="standard";
const profiles={
  easy:{obDensity:0.6, speedMax:28, colours:[0x94f2ff,0xa6ff9e]},
  standard:{obDensity:1.0, speedMax:30, colours:[0xffffff,0x00e5ff]},
  hard:{obDensity:1.4, speedMax:34, colours:[0xffa447,0xff4fb6]},
};
function applyProfile(p){
  const c=profiles[p].colours;
  laneStrips.forEach((s,i)=> s.material.color.setHex(i%2?c[0]:c[1]));
  maxSpeed=profiles[p].speedMax; profile=p;
  centerFlash({easy:"üå¥ Neon Paradise",standard:"üåÜ Pulse District",hard:"üî• Chaos Core"}[p]+" engaged",900);
}
let nextTunnelAt=700 + Math.random()*200;

/* Quiz (every 500 m) */
const QUIZ=[/* ‚Ä¶ (keep your 50 items here unchanged) ‚Ä¶ */];
let quizOrder=[],quizPtr=0;
function seedQuizOrder(){ quizOrder=[...Array(QUIZ.length).keys()]; for(let i=quizOrder.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [quizOrder[i],quizOrder[j]]=[quizOrder[j],quizOrder[i]];} quizPtr=0; }
function nextQuestionIndex(){ const idx=quizOrder[quizPtr]; quizPtr=(quizPtr+1)%QUIZ.length; if(quizPtr===0) seedQuizOrder(); return idx; }
let timerId=null; const QUESTION_TIME=10; let tLeft=QUESTION_TIME;
const $=(id)=>document.getElementById(id);
const hud={time:$("time"),speed:$("speed"),distM:$("distM"),distKm:$("distKm"),score:$("score"),correct:$("correct"),merits:$("merits")};
const overlay=$("overlay"), qText=$("qText"), answersEl=$("answers"), tLeftEl=$("tLeft"), centerMsg=$("centerMsg"), toast=$("toast"), review=$("review"), reviewList=$("reviewList"), finalMerits=$("finalMerits");
function startTimer(onExpire){ clearInterval(timerId); tLeft=QUESTION_TIME; tLeftEl.textContent=String(tLeft);
  timerId=setInterval(()=>{ tLeft--; tLeftEl.textContent=String(tLeft); if(tLeft<=0){ clearInterval(timerId); onExpire(); } },1000); }
function awardIfMerit(){ const t=Math.floor(correct/10); if(t>merits){ merits=t; hud.merits.textContent=String(merits); centerFlash(`üèÖ Merit +1 (Total ${merits})`,1200);} }
const askedLog=[];
function askQuestion(){
  pausedForQuiz=true; overlay.style.display="flex"; answersEl.innerHTML="";
  const idx=nextQuestionIndex(); const q=QUIZ[idx]; qText.textContent=q.q;
  [0,1,2,3].sort(()=>Math.random()-0.5).forEach(opt=>{
    const b=document.createElement("button"); b.className="choice"; b.textContent=q.a[opt];
    b.onclick=()=>{ clearInterval(timerId);
      const ok=(opt===q.c); askedLog.push({q:q.q,a:q.a,correctIndex:q.c,chosenIndex:opt,result: ok?"correct":"wrong"});
      if(ok){ correct++; bonusScore+=25; hud.correct.textContent=String(correct); awardIfMerit(); }
      else  { bonusScore=Math.max(0,bonusScore-5); }
      overlay.style.display="none"; pausedForQuiz=false;
    };
    answersEl.appendChild(b);
  });
  startTimer(()=>{ askedLog.push({q:q.q,a:q.a,correctIndex:q.c,chosenIndex:null,result:"timeout"}); bonusScore=Math.max(0,bonusScore-5); overlay.style.display="none"; pausedForQuiz=false; });
}
$("skip").onclick=()=>{ clearInterval(timerId); overlay.style.display="none"; pausedForQuiz=false; };
$("resume").onclick=()=>{ clearInterval(timerId); overlay.style.display="none"; pausedForQuiz=false; };

/* Leaderboard & Settings (unchanged from last version) */
const LB_KEY="nd_lotf_leaderboard_v2";
const getLB=()=>{try{return JSON.parse(localStorage.getItem(LB_KEY)||"[]")}catch(_){return[]}};
const setLB=(list)=>localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0,10)));
const DEF_NAME_KEY="nd_default_name", DEF_CLASS_KEY="nd_default_class";
const getDefaultName=()=>localStorage.getItem(DEF_NAME_KEY)||"Player";
const getDefaultClass=()=>localStorage.getItem(DEF_CLASS_KEY)||"Class";
const setDefaults=(n,c)=>{localStorage.setItem(DEF_NAME_KEY,n||"Player"); localStorage.setItem(DEF_CLASS_KEY,c||"Class");};
$("settingsBtn").onclick = ()=>{ $("defName").value=getDefaultName(); $("defClass").value=getDefaultClass(); $("settings").style.display="flex"; };
$("saveSettings").onclick = ()=>{ setDefaults($("defName").value.trim()||"Player", $("defClass").value.trim()||"Class"); $("settings").style.display="none"; centerFlash("‚úî Defaults saved",800); };
$("closeSettings").onclick = ()=> $("settings").style.display="none";
function renderLeaderboard(){
  const lb=getLB().slice(0,10), body=$("lbBody"); body.innerHTML="";
  lb.forEach((e,i)=>{ const tr=document.createElement("tr"); tr.className="entry";
    tr.innerHTML=`<td>${i+1}</td><td>${e.name}</td><td>${e.classTag??"‚Äî"}</td><td>${e.score}</td><td>${e.correct}</td><td>${(e.distKm||0).toFixed(2)} km</td><td>${e.merits}</td>`;
    body.appendChild(tr);
  });
}
$("lbBtn").onclick = ()=>{ renderLeaderboard(); reviewList.innerHTML=""; review.style.display="flex"; };
$("saveScore").onclick = ()=>{
  const name=($("playerName").value||"Player").slice(0,24);
  const classTag=($("playerClass").value||"Class").slice(0,24);
  const lb=getLB(); lb.push({name,classTag,score,correct,distM:Math.floor(dist),distKm:dist/1000,merits,t:Date.now()});
  lb.sort((a,b)=>b.score-a.score); setLB(lb); renderLeaderboard(); centerFlash("üíæ Saved to leaderboard",800);
};

/* Pause/Restart */
$("pauseBtn").onclick=()=>{ running=!running; centerFlash(running?"‚ñ∂ RESUME":"II PAUSED",800); };
$("restartBtn").onclick=reset;
$("playAgain").onclick=()=>{ review.style.display="none"; reset(); };
$("closeReview").onclick=()=>{ review.style.display="none"; };

/* Helpers */
const aabbIntersect=(a,b)=> (Math.abs(a.x-b.x) <= (a.w+b.w)*0.5) && (Math.abs(a.z-b.z) <= (a.d+b.d)*0.5);
const carAABB=()=> ({x:car.position.x + curveX(car.position.z), z:car.position.z, w:1.6, d:2.6});
const centerFlash=(m,ms=800)=>{ centerMsg.textContent=m; centerMsg.style.display="block"; setTimeout(()=>centerMsg.style.display="none",ms); };
const fmtTime=s=>{ s=Math.max(0,Math.floor(s)); const m=String(Math.floor(s/60)).padStart(2,"0"); const sec=String(s%60).padStart(2,"0"); return `${m}:${sec}`; };

/* Reset */
let nextQuestionAt = 500; // meters
function reset(){
  running=true; pausedForQuiz=false; boostTimer=0; speedupTimer=0;
  speed=12; targetSpeed=16; maxSpeed=profiles[profile].speedMax; dist=0; baseScore=0; bonusScore=0; score=0;
  correct=0; merits=0; wallHitCooldown=0; laneIndex=1; nextQuestionAt=500;
  hud.correct.textContent="0"; hud.merits.textContent="0";
  vy=0; onGround=true; car.position.set(lanes[laneIndex],baseY,4);
  sessionLeft=SESSION_DURATION; hud.time.textContent=fmtTime(sessionLeft);
  askedLog.length=0; seedQuizOrder(); applyProfile("standard"); nextTunnelAt=700 + Math.random()*200;

  boosts.forEach(b=>{ b.position.set(0,0.03, -Math.random()*SEG_COUNT*SEG_LEN); });
  speedups.forEach(s=>{ s.userData.baseX=laneX(); s.position.set(0.0,0.5, -Math.random()*SEG_COUNT*SEG_LEN); });
  obstacles.forEach(o=>{ o.userData.baseX=laneX(); o.userData.phase=Math.random()*Math.PI*2; o.position.set(0.0,0.6, -Math.random()*SEG_COUNT*SEG_LEN); });
  ramps.forEach(r=>{ r.userData.baseX=laneX(); r.position.set(0.0,0.1, -Math.random()*SEG_COUNT*SEG_LEN); });
  tunnels.forEach(t=>{ t.userData.used=false; t.position.z = -Math.random()*SEG_COUNT*SEG_LEN - 100; t.children.forEach(p=> p.userData.baseX=p.position.x); });

  centerFlash("‚ü≤ RESTART");
}

/* Main loop */
let hitCooldown=0;
function animate(now){
  requestAnimationFrame(animate);
  const dt=Math.min(0.05,(now - tPrev)/1000); tPrev=now;
  hitCooldown=Math.max(0,hitCooldown - dt);
  wallHitCooldown=Math.max(0, wallHitCooldown - dt);

  if(running && !pausedForQuiz){
    sessionLeft -= dt;
    if(sessionLeft<=0){
      sessionLeft=0; running=false; hud.time.textContent=fmtTime(0);
      const lb=getLB(); lb.push({name:getDefaultName(), classTag:getDefaultClass(), score, correct, distM:Math.floor(dist), distKm:dist/1000, merits, t:Date.now()});
      lb.sort((a,b)=>b.score-a.score); setLB(lb);
      showReview();
    } else hud.time.textContent=fmtTime(sessionLeft);
  }
  if(!running || pausedForQuiz){ renderer.render(scene,camera); return; }

  /* Lane snap: place car exactly on the lane each frame */
  car.position.x = lanes[laneIndex];

  /* Speed control */
  if((window.keyBoost)||false); // placeholder
  const boostKey = (window.keyBoost = (window.keyBoost||false)) || (window.keyBoost=false);
  const keysDown = (e)=>{};
  if((keysDown,false)); // silence linter
  // keyboard handled by laneChange; only boost/brake below via keys
  const keys = {};
  addEventListener("keydown", e=>{ keys[e.key.toLowerCase()] = true; });
  addEventListener("keyup",   e=>{ keys[e.key.toLowerCase()] = false; });
  const boostHeld = keys[" "]||keys["arrowup"];
  const brakeHeld = keys["shift"]||keys["arrowdown"];
  if(boostHeld) targetSpeed = Math.min(maxSpeed, targetSpeed + 8*dt);
  if(brakeHeld) targetSpeed = Math.max(minSpeed, targetSpeed - 18*dt);
  if(boostTimer>0){ targetSpeed = Math.max(targetSpeed, maxSpeed); boostTimer -= dt; }
  if(speedupTimer>0){ targetSpeed = Math.max(targetSpeed, maxSpeed-2); speedupTimer -= dt; }
  speed = THREE.MathUtils.damp(speed, targetSpeed, 6, dt);

  /* Jump physics (no idle bob) */
  if(!onGround){ vy += gravity*dt; car.position.y += vy*dt; if(car.position.y<=baseY){ car.position.y=baseY; vy=0; onGround=true; } }

  /* World scroll */
  const moveZ = speed*dt;
  dist += moveZ; hud.distM.textContent=String(Math.floor(dist)); hud.distKm.textContent=(dist/1000).toFixed(2);
  baseScore = Math.floor(dist) + Math.floor(speed*2);
  score = baseScore + bonusScore;
  curvePhase += moveZ*20;

  segments.forEach(g=>{ g.position.z += moveZ; g.position.x = curveX(g.position.z); if(g.position.z>SEG_LEN){ g.position.z -= SEG_LEN*SEG_COUNT; } });
  billboards.forEach(b=>{ b.position.z += moveZ; b.position.x = (b.position.x<0?-1:1)*(TRACK_WIDTH/2-0.6) + curveX(b.position.z); if(b.position.z>20) b.position.z -= SEG_LEN*SEG_COUNT*1.7; });

  /* Move items/recycle */
  boosts.forEach(b=>{ b.position.z += moveZ; b.position.x = curveX(b.position.z); if(b.position.z>12){ b.position.z -= SEG_LEN*SEG_COUNT; } });
  speedups.forEach(s=>{ s.position.z += moveZ; s.position.x = s.userData.baseX + curveX(s.position.z); if(s.position.z>12){ s.position.z -= SEG_LEN*SEG_COUNT + 40 + Math.random()*40; s.userData.baseX=laneX(); } });
  ramps.forEach(r=>{ r.position.z += moveZ; r.position.x = r.userData.baseX + curveX(r.position.z); if(r.position.z>12){ r.position.z -= SEG_LEN*SEG_COUNT + 40 + Math.random()*40; r.userData.baseX=laneX(); } });
  obstacles.forEach(o=>{ o.position.z += moveZ; const base=o.userData.baseX + Math.sin(now*0.002 + o.userData.phase)*o.userData.amp; o.position.x = base + curveX(o.position.z);
    if(o.position.z>12){ o.position.z -= SEG_LEN*SEG_COUNT; o.userData.baseX=laneX(); o.userData.phase=Math.random()*Math.PI*2; } });

  /* Tunnel portals (drive-through) */
  tunnels.forEach(t=>{
    t.position.z += moveZ; t.children.forEach(p=> p.position.x = p.userData.baseX + curveX(t.position.z));
    if(t.position.z>12){
      t.userData.used=false; t.position.z -= SEG_LEN*SEG_COUNT + 120;
      [...t.children].forEach(c=>t.remove(c));
      const count=(Math.random()<0.5)?2:3; const idxs=[0,1,2].sort(()=>Math.random()-0.5).slice(0,count).sort((a,b)=>a-b);
      const pool=["easy","standard","hard"].sort(()=>Math.random()-0.5);
      for(let i=0;i<count;i++){ const pr=pool[i]; const p=new THREE.Mesh(portalGeo, portalMats[pr]);
        p.rotation.x=Math.PI/2; p.position.set(lanes[idxs[i]],1.4,0); p.userData={type:"portal", profile:pr, baseX:p.position.x};
        const plate=new THREE.Mesh(new THREE.BoxGeometry(1.6,0.08,0.6), new THREE.MeshStandardMaterial({color:0x12224c, emissive:0x12224c}));
        plate.position.set(0,-0.9,0); p.add(plate); t.add(p);
      }
    }
  });
  // select portal on overlap
  const carBox={x:car.position.x + curveX(car.position.z), z:car.position.z, w:1.6, d:2.6};
  tunnels.forEach(t=>{
    if(t.userData.used) return;
    for(const p of t.children){
      const box={x:p.userData.baseX + curveX(t.position.z), z:t.position.z, w:1.6, d:1.2};
      if(aabbIntersect(carBox, box)){ applyProfile(p.userData.profile); t.userData.used=true; t.position.z -= SEG_LEN*SEG_COUNT + 120; break; }
    }
  });

  /* Walls + obstacles */
  const edge=TRACK_WIDTH/2 - 1;
  const carGlobalX=car.position.x + curveX(car.position.z);
  if(Math.abs(carGlobalX)>edge){
    targetSpeed = Math.max(minSpeed, targetSpeed - 10*dt);
    car.position.x = THREE.MathUtils.clamp(car.position.x, -edge - curveX(car.position.z), edge - curveX(car.position.z));
    if(wallHitCooldown<=0){ centerFlash("‚ö° WALL HIT ‚Äì SLOW!", 300); wallHitCooldown=0.4; }
  }

  if(onGround){
    obstacles.forEach(o=>{
      const box={x:(o.userData.baseX + Math.sin(now*0.002 + o.userData.phase)*o.userData.amp) + curveX(o.position.z), z:o.position.z, w:1.8, d:1.4};
      if(hitCooldown<=0 && aabbIntersect(carBox, box)){
        targetSpeed=Math.max(minSpeed, targetSpeed - 4.5); bonusScore=Math.max(0, bonusScore - 5);
        centerFlash("üõë Mr Samuels says: Watch it!",650); o.position.z -= 8; hitCooldown=0.8;
      }
    });
  }

  /* Ask a question every 500 m */
  if(!pausedForQuiz && dist >= nextQuestionAt){
    nextQuestionAt += 500;
    askQuestion();
  }

  /* Camera (direct follow; no sway) */
  camera.position.x = car.position.x*0.55 + curveX(car.position.z)*0.2;
  camera.position.z = car.position.z + 6;
  camera.lookAt(car.position.x + curveX(car.position.z), 0.45, car.position.z - 6);

  hud.speed.textContent=String(Math.round(speed));
  hud.score.textContent=String(score);

  renderer.render(scene, camera);
}
reset();
requestAnimationFrame(animate);

/* Resize & prevent scroll on touch controls */
addEventListener("resize", ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });
["left","right","boost","brake"].forEach(id=>{
  const el=document.getElementById(id);
  ["touchstart","touchmove","touchend"].forEach(ev=> el.addEventListener(ev, e=>e.preventDefault(), {passive:false}));
});

/* Review helpers */
function showReview(){
  finalMerits.textContent=String(merits);
  reviewList.innerHTML="";
  askedLog.forEach((item,i)=>{
    const row=document.createElement("div"); row.className="qrow";
    const chosen=item.chosenIndex!=null ? item.a[item.chosenIndex] : "No answer";
    const correctAns=item.a[item.correctIndex];
    const tag=item.result==="correct" ? `<span class="correctTag">‚úì Correct</span>` :
               item.result==="wrong"   ? `<span class="wrongTag">‚úó Wrong</span>` :
                                         `<span class="wrongTag">‚åõ Time</span>`;
    row.innerHTML = `<div><b>Q${i+1}.</b> ${item.q} ${tag}</div>
                     <div>Your answer: <b>${chosen}</b></div>
                     <div>Correct answer: <b>${correctAns}</b></div>`;
    reviewList.appendChild(row);
  });
  document.getElementById("playerName").value=getDefaultName();
  document.getElementById("playerClass").value=getDefaultClass();
  renderLeaderboard(); review.style.display="flex";
}
</script>
</body>
</html>
