<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Neon Drift: Endless Cyberpunk Racer + Quiz</title>
<style>
  :root{
    --bg:#05060a; --panel:#0e1220; --accent:#00e5ff; --accent2:#ff2bd6; --text:#e7f6ff; --good:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #ui{
    position:fixed; inset:0 0 auto 0; display:flex; gap:12px; align-items:center; padding:10px 12px;
    background:linear-gradient(to bottom,rgba(0,0,0,.55),rgba(0,0,0,0));
    user-select:none; -webkit-user-select:none; pointer-events:none;
  }
  .pill{pointer-events:auto; background:rgba(14,18,32,.6); border:1px solid #243056; border-radius:12px; padding:8px 10px; display:flex; gap:10px; align-items:center}
  .stat{font-weight:700}
  .btn{pointer-events:auto; background:var(--accent); border:none; color:#001018; font-weight:900; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn.ghost{background:transparent;border:2px solid var(--accent);color:var(--text)}
  #overlay{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.65); backdrop-filter: blur(4px);
  }
  .card{
    width:min(720px,92vw); background:var(--panel); border:1px solid #26345e; border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.45)
  }
  .card h2{margin:0 0 8px}
  .meta{display:flex;gap:10px;align-items:center;opacity:.9}
  .timer{margin-left:auto;font-weight:900}
  .answers{display:grid; gap:10px; margin-top:10px}
  .answers button{border:none;border-radius:12px; padding:12px; font-weight:700; cursor:pointer}
  .answers button:hover{filter:brightness(1.08)}
  .ok{background:rgba(34,197,94,.15); color:#b5f7c8; border:2px solid var(--good)}
  .no{background:rgba(239,68,68,.15); color:#ffc1c1; border:2px solid var(--bad)}
  #centerMsg{
    position:fixed; left:50%; top:14%; transform:translateX(-50%); font-weight:900; letter-spacing:.5px;
    background:rgba(14,18,32,.6); border:1px solid #243056; border-radius:12px; padding:8px 12px; display:none
  }
  #pad{
    position:fixed; right:14px; bottom:14px; display:grid; grid-template-columns:68px 68px; gap:10px;
    opacity:.95; user-select:none
  }
  .ctl{
    background:rgba(14,18,32,.6); border:2px solid #2a3b6a; border-radius:14px; color:#cfe6ff; font-size:18px; font-weight:900;
    display:flex; align-items:center; justify-content:center; height:60px; cursor:pointer
  }
  .ctl:active{transform:scale(.98); border-color:var(--accent)}
  @media (min-width:880px){ #pad{display:none} }
  #toast{
    position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#091022; color:#a8eaff;
    border:1px solid #1d2a52; border-radius:12px; padding:8px 12px; display:none
  }
  a, a:visited{color:var(--accent)}
</style>
</head>
<body>
<div id="ui">
  <div class="pill"><span>Speed:</span> <span class="stat" id="speed">0</span></div>
  <div class="pill"><span>Coins:</span> <span class="stat" id="coins">0</span></div>
  <div class="pill"><span>Distance:</span> <span class="stat" id="dist">0</span> m</div>
  <div class="pill"><span>Score:</span> <span class="stat" id="score">0</span></div>
  <div class="pill"><span>Correct:</span> <span class="stat" id="correct">0</span></div>
  <div class="pill"><span>Merits:</span> <span class="stat" id="merits">0</span></div>
  <button class="btn ghost" id="pauseBtn" style="margin-left:auto">Pause</button>
  <button class="btn" id="restartBtn">Restart</button>
</div>

<div id="centerMsg"></div>
<div id="toast"></div>

<!-- Quiz Overlay -->
<div id="overlay">
  <div class="card">
    <div class="meta">
      <h2 style="margin:0">Quiz: <em>Lord of the Flies</em></h2>
      <div class="timer">⏱️ <span id="tLeft">10</span>s</div>
    </div>
    <div id="qText" style="margin-top:6px">Question here…</div>
    <div class="answers" id="answers"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn ghost" id="skip">Skip</button>
      <button class="btn" id="resume">Resume</button>
    </div>
  </div>
</div>

<!-- Mobile controls -->
<div id="pad" aria-label="controls">
  <div class="ctl" id="left">◀</div>
  <div class="ctl" id="right">▶</div>
  <div class="ctl" id="boost">BOOST</div>
  <div class="ctl" id="brake">BRAKE</div>
</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

const DPR = Math.min(2, window.devicePixelRatio || 1);

/* ---------- Scene / Camera / Renderer ---------- */
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x05060a, 0.03);

const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
camera.position.set(0, 2.4, 6);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setClearColor(0x05060a, 1);
renderer.setPixelRatio(DPR);
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ---------- Neon world lighting ---------- */
const hemi = new THREE.HemisphereLight(0x1ae0ff, 0x090a12, 0.5);
scene.add(hemi);
const dir = new THREE.DirectionalLight(0xff2bd6, 0.6);
dir.position.set(5, 8, 3);
scene.add(dir);

/* ---------- Track parameters ---------- */
const TRACK_WIDTH = 8;
const SEG_LEN = 40;
const SEG_COUNT = 12;
const WALL_H = 5;
const FLOOR_Y = 0;

const neonMat = (c)=> new THREE.MeshStandardMaterial({
  color: c, metalness: 0.4, roughness: 0.2, emissive: c, emissiveIntensity: 0.5
});
const darkMat = new THREE.MeshStandardMaterial({color:0x0b0f1c, metalness:0.2, roughness:0.9});
const glowLaneMat = (c)=> new THREE.MeshBasicMaterial({color:c});

/* ---------- Build recycled track segments ---------- */
const segments = [];
const wallsLeft = [];
const wallsRight = [];
const floors = [];
const laneStrips = [];

const floorGeo = new THREE.PlaneGeometry(TRACK_WIDTH, SEG_LEN);
const wallGeo  = new THREE.PlaneGeometry(SEG_LEN, WALL_H);
const stripGeo = new THREE.PlaneGeometry(TRACK_WIDTH, 0.1);

for (let i=0;i<SEG_COUNT;i++){
  const group = new THREE.Group();

  const floor = new THREE.Mesh(floorGeo, darkMat);
  floor.rotation.x = -Math.PI/2;
  floor.position.set(0, FLOOR_Y, -i*SEG_LEN);
  group.add(floor);
  floors.push(floor);

  const left = new THREE.Mesh(wallGeo, neonMat(0x1935ff));
  left.rotation.y = Math.PI/2;
  left.position.set(-TRACK_WIDTH/2, WALL_H/2, -i*SEG_LEN);
  group.add(left);
  wallsLeft.push(left);

  const right = new THREE.Mesh(wallGeo, neonMat(0x00e5ff));
  right.rotation.y = -Math.PI/2;
  right.position.set(TRACK_WIDTH/2, WALL_H/2, -i*SEG_LEN);
  group.add(right);
  wallsRight.push(right);

  for(let s=0; s<SEG_LEN; s+=2){
    const strip = new THREE.Mesh(stripGeo, glowLaneMat((s%4===0)?0xff2bd6:0x00e5ff));
    strip.rotation.x = -Math.PI/2;
    strip.position.set(0, FLOOR_Y+0.01, -i*SEG_LEN - s);
    group.add(strip);
    laneStrips.push(strip);
  }

  segments.push(group);
  scene.add(group);
}

/* ---------- Player car ---------- */
const car = new THREE.Group();
const body = new THREE.Mesh(
  new THREE.BoxGeometry(1.1, 0.4, 2),
  new THREE.MeshStandardMaterial({color:0x0efeff, emissive:0x0efeff, emissiveIntensity:0.4, metalness:0.5, roughness:0.3})
);
body.position.y = 0.35;
car.add(body);
const canopy = new THREE.Mesh(
  new THREE.BoxGeometry(0.7, 0.3, 0.8),
  new THREE.MeshStandardMaterial({color:0xff2bd6, emissive:0xff2bd6, emissiveIntensity:0.6})
);
canopy.position.set(0,0.6,-0.1);
car.add(canopy);
const barGeo = new THREE.BoxGeometry(0.2,0.2,1.8);
const leftBar = new THREE.Mesh(barGeo, neonMat(0x00e5ff));
leftBar.position.set(-0.65,0.25,0);
const rightBar = new THREE.Mesh(barGeo, neonMat(0x1935ff));
rightBar.position.set(0.65,0.25,0);
car.add(leftBar,rightBar);

car.position.set(0, 0.2, 4);
scene.add(car);

/* ---------- Coins, Boosts, Obstacles ---------- */
const coinGeo = new THREE.TorusGeometry(0.25, 0.09, 12, 24);
const coinMat = new THREE.MeshStandardMaterial({color:0xffe066, emissive:0xffcc00, emissiveIntensity:0.7, metalness:0.3, roughness:0.4});
const coins = [];

const boostGeo = new THREE.BoxGeometry(TRACK_WIDTH*0.7, 0.05, 2);
const boostMat = new THREE.MeshBasicMaterial({color:0x73ffb2});
const boosts = [];

const obstacleGeo = new THREE.BoxGeometry(1.4, 1, 1.4);
const obstacleMat = new THREE.MeshStandardMaterial({color:0xff2bd6, emissive:0xff2bd6, emissiveIntensity:0.6, metalness:0.4, roughness:0.3});
const obstacles = [];

const spawnPoolZ = -SEG_COUNT*SEG_LEN + 10;

function randX(){ return (Math.random()*0.8-0.4) * (TRACK_WIDTH*0.8); }
function laneX(){ const lanes=[-2.6,0,2.6]; return lanes[Math.floor(Math.random()*lanes.length)]; }

function spawnCoin(z){
  const m = new THREE.Mesh(coinGeo, coinMat);
  m.position.set(randX(), 0.7, z);
  m.userData.type = "coin";
  scene.add(m); coins.push(m);
}
function spawnBoost(z){
  const m = new THREE.Mesh(boostGeo, boostMat);
  m.position.set(0, 0.03, z);
  m.rotation.x = -Math.PI/2;
  m.userData.type = "boost";
  scene.add(m); boosts.push(m);
}
function spawnObstacle(z){
  const m = new THREE.Mesh(obstacleGeo, obstacleMat);
  m.position.set(laneX(), 0.5, z);
  m.userData.type = "obstacle";
  // give each obstacle a small side-to-side oscillation
  m.userData.baseX = m.position.x;
  m.userData.phase = Math.random()*Math.PI*2;
  m.userData.amp = 0.6 + Math.random()*0.7;
  scene.add(m); obstacles.push(m);
}

/* FEWER COINS: cut to 10 seeds (was ~24) */
for (let i=0;i<10;i++) spawnCoin(spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN);
/* Boosts unchanged (can tweak if you want fewer/faster) */
for (let i=0;i<8;i++) spawnBoost(spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN);
/* New obstacles */
for (let i=0;i<14;i++) spawnObstacle(spawnPoolZ + Math.random()*SEG_COUNT*SEG_LEN);

/* ---------- Game state ---------- */
let running = true, pausedForQuiz = false;
let tPrev = performance.now();
let speed = 18, targetSpeed = 22, maxSpeed = 32, minSpeed = 6;
let steer = 0;
let dist = 0;
let score = 0;
let coinsCount = 0;
let boostTimer = 0;

let correct = 0;
let merits = 0;

const hud = {
  speed: document.getElementById("speed"),
  coins: document.getElementById("coins"),
  dist:  document.getElementById("dist"),
  score: document.getElementById("score"),
  correct: document.getElementById("correct"),
  merits: document.getElementById("merits"),
};
const overlay = document.getElementById("overlay");
const qText = document.getElementById("qText");
const answersEl = document.getElementById("answers");
const tLeftEl = document.getElementById("tLeft");
const centerMsg = document.getElementById("centerMsg");
const toast = document.getElementById("toast");

/* ---------- Input ---------- */
const keys = {};
window.addEventListener("keydown", e=>{ keys[e.key.toLowerCase()] = true; });
window.addEventListener("keyup",   e=>{ keys[e.key.toLowerCase()] = false; });

document.getElementById("left").addEventListener("pointerdown", ()=>keys["arrowleft"]=true);
document.getElementById("right").addEventListener("pointerdown", ()=>keys["arrowright"]=true);
document.getElementById("boost").addEventListener("pointerdown", ()=>keys[" "]=true);
document.getElementById("brake").addEventListener("pointerdown", ()=>keys["shift"]=true);
["left","right","boost","brake"].forEach(id=>{
  document.getElementById(id).addEventListener("pointerup", ()=>{
    if(id==="left") keys["arrowleft"]=false;
    if(id==="right") keys["arrowright"]=false;
    if(id==="boost") keys[" "]=false;
    if(id==="brake") keys["shift"]=false;
  });
});

/* ---------- Collision helpers ---------- */
function aabbIntersect(a,b){
  return (Math.abs(a.x-b.x) <= (a.w+b.w)*0.5) && (Math.abs(a.z-b.z) <= (a.d+b.d)*0.5);
}
function carAABB(){
  return {x:car.position.x, z:car.position.z, w:1.3, d:2.0};
}

/* ---------- Quiz Bank (50 Qs) ---------- */
const QUIZ = [
  {q:"Who is elected chief at the start?", a:["Jack","Piggy","Ralph","Simon"], c:2},
  {q:"The conch symbolizes…", a:["Violence","Civilization & order","Hunting","Fear"], c:1},
  {q:"Who represents rational/scientific thinking?", a:["Piggy","Jack","Roger","Percival"], c:0},
  {q:"The 'beast' chiefly represents…", a:["A real animal","The boys’ inner savagery","A sea monster","A ghost"], c:1},
  {q:"Leader of the hunters?", a:["Ralph","Roger","Jack","Simon"], c:2},
  {q:"The 'Lord of the Flies' literally is…", a:["A skull","A pig’s head on a stake","A mask","A conch"], c:1},
  {q:"Why is the signal fire important?", a:["Decoration","Rescue/connection to civilization","Warmth only","Cooking only"], c:1},
  {q:"Simon dies during…", a:["A storm frenzy/dance","A quiet night","A boat trip","A meeting"], c:0},
  {q:"The most sadistic boy is…", a:["Piggy","Ralph","Roger","Samneric"], c:2},
  {q:"What happens to the conch?", a:["Kept safe","Lost at sea","Shatters with Piggy’s death","Turns gold"], c:2},
  {q:"Painted masks allow boys to…", a:["See better","Hide identity & unleash savagery","Swim faster","Talk to adults"], c:1},
  {q:"The boys are rescued when…", a:["A naval officer sees a fire","A plane lands","They build a raft","They are not rescued"], c:0},
  {q:"Ralph’s main priority is…", a:["Hunting pigs","Shelters & keeping the fire","Swimming","Cave exploring"], c:1},
  {q:"Piggy’s glasses symbolize…", a:["Wealth","Knowledge/technology & fire","Beauty","Friendship"], c:1},
  {q:"The island initially appears as…", a:["A paradise/Garden of Eden","A city","A prison","A desert"], c:0},
  {q:"Jack’s tribe hunts Ralph by…", a:["Setting the forest on fire","Debating","Singing","Sailing"], c:0},
  {q:"Golding suggests human nature is…", a:["Naturally orderly","Easily corrupted/prone to savagery","Unchangingly good","Fixed by rules"], c:1},
  {q:"Samneric are…", a:["Two leaders","Twins treated as one","Younger than Littluns","Adults"], c:1},
  {q:"Who learns the 'beast' is a dead parachutist?", a:["Ralph","Simon","Roger","Jack"], c:1},
  {q:"Piggy is killed by…", a:["A falling tree","A rock pushed by Roger","A spear","A snake"], c:1},
  {q:"Ralph is associated most with…", a:["Order & leadership","Mysticism","Savage delight","Cowardice"], c:0},
  {q:"Jack is associated most with…", a:["Democracy","Savage authority & hunting","Scientific method","Compassion"], c:1},
  {q:"Simon represents…", a:["Pure evil","Spiritual insight/morality","Cunning politics","Cowardice"], c:1},
  {q:"The signal fire going out signifies…", a:["Freedom","Loss of hope/civilization","Success","A feast"], c:1},
  {q:"The sow’s head speaks to Simon as…", a:["A hallucination/truth about evil","A real demon","A rescue signal","A lullaby"], c:0},
  {q:"Littluns mainly symbolize…", a:["Brute force","Innocence/vulnerability of society","Government","Technology"], c:1},
  {q:"Roger’s character arc shows…", a:["Growing kindness","Increasing cruelty without restraint","Academic focus","Homesickness"], c:1},
  {q:"The face paint functions as…", a:["Camouflage & loss of identity","Sunscreen","War honor","Tribal marriage"], c:0},
  {q:"Ralph weeps at the end for…", a:["Lost glasses","The end of childhood & darkness of man","Lost boat","The island"], c:1},
  {q:"Piggy’s real name is…", a:["Never given","Peter","Philip","Percival"], c:0},
  {q:"Who suggests building shelters first?", a:["Ralph","Jack","Piggy","Roger"], c:0},
  {q:"Why do the boys first start a fire?", a:["Cooking","Rescue signal","Warmth","Fun"], c:1},
  {q:"What does the dead parachutist symbolize?", a:["External war intruding/irony of adult 'civilization'","A guardian spirit","A map","A rescue plan"], c:0},
  {q:"Who destroys the conch?", a:["Roger (by the boulder)","Jack","Ralph","Simon"], c:0},
  {q:"The 'dance' that kills Simon shows…", a:["Community care","Power of mob mentality","Scientific test","Religious worship only"], c:1},
  {q:"Jack’s hunters let the fire go out because…", a:["They were hunting and careless","It rained","They slept","Piggy put it out"], c:0},
  {q:"Which item starts the first signal fire?", a:["Matches","Piggy’s glasses","Flint","Magnifying glass"], c:1},
  {q:"Percival Wemys Madison forgets…", a:["His name/address under trauma","How to swim","How to cook","How to read"], c:0},
  {q:"The naval officer’s uniform symbolizes…", a:["Perfect goodness","Civilization’s own violence/hypocrisy","Magic","Nature"], c:1},
  {q:"Castle Rock becomes…", a:["A playground","Ralph’s home","Jack’s fortress/power base","A dock"], c:2},
  {q:"Ralph’s hair growing & irritation symbolize…", a:["Maturity and discomfort with savagery","Style","Wisdom","Health"], c:0},
  {q:"Who remains loyal longest to Ralph?", a:["Roger","Samneric","Jack","Maurice"], c:1},
  {q:"'The beast is us' best fits which boy?", a:["Simon","Jack","Piggy","Roger"], c:0},
  {q:"The sow’s head is offered to…", a:["The beast","Ralph","The officer","The conch"], c:0},
  {q:"Jack steals…", a:["The conch","Piggy’s glasses (for fire)","The parachute","The knife"], c:1},
  {q:"When the conch shatters, it marks…", a:["Restoration of order","Total collapse of order","Start of feast","Rescue"], c:1},
  {q:"Ralph’s leadership is chosen by…", a:["Combat","Vote by a group","Drawing lots","Adults"], c:1},
  {q:"'Kill the beast! Cut his throat!' is…", a:["A rescue chant","A hunting/violence chant","A prayer","A rule"], c:1},
  {q:"The first fire causes…", a:["Nothing","A runaway blaze and a missing boy","Immediate rescue","A feast"], c:1},
  {q:"Golding’s main theme is…", a:["Technology saves all","Inherent darkness in human nature under weak constraints","Adults are flawless","Islands are safe"], c:1},
  {q:"The mask makes Jack feel…", a:["Ashamed","Liberated from shame/self","Sleepy","Older"], c:1},
];

/* ---------- Quiz Logic (10s timer) & merits ---------- */
let quizOrder = [...Array(QUIZ.length).keys()];
shuffle(quizOrder);
let quizPtr = 0;
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

let timerId = null;
const QUESTION_TIME = 10; // seconds
let tLeft = QUESTION_TIME;

function nextQuestionIndex(){
  const idx = quizOrder[quizPtr];
  quizPtr = (quizPtr+1) % QUIZ.length;
  if(quizPtr===0) shuffle(quizOrder);
  return idx;
}
function showToast(msg, ms=900){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none", ms);
}
function centerFlash(msg, ms=800){
  centerMsg.textContent = msg;
  centerMsg.style.display = "block";
  setTimeout(()=>centerMsg.style.display="none", ms);
}
function startTimer(onExpire){
  clearInterval(timerId);
  tLeft = QUESTION_TIME;
  tLeftEl.textContent = tLeft.toString();
  timerId = setInterval(()=>{
    tLeft--;
    tLeftEl.textContent = tLeft.toString();
    if(tLeft<=0){
      clearInterval(timerId);
      onExpire();
    }
  }, 1000);
}
function awardIfMerit(){
  const target = Math.floor(correct/10);
  if(target > merits){
    merits = target;
    hud.merits.textContent = merits.toString();
    centerFlash(`🏅 Merit +1 (Total ${merits})`, 1200);
  }
}
function askQuestion(){
  pausedForQuiz = true;
  overlay.style.display = "flex";
  answersEl.innerHTML = "";

  const qIdx = nextQuestionIndex();
  const q = QUIZ[qIdx];
  qText.textContent = q.q;

  const order = [0,1,2,3]; shuffle(order);
  const correctIndexInOrder = order.indexOf(q.c);

  order.forEach((optIndex,i)=>{
    const b = document.createElement("button");
    b.className = (i===correctIndexInOrder) ? "ok" : "no";
    b.textContent = q.a[optIndex];
    b.onclick = ()=>{
      clearInterval(timerId);
      const wasCorrect = (i===correctIndexInOrder);
      if(wasCorrect){
        correct++;
        score += 25;
        hud.correct.textContent = correct.toString();
        awardIfMerit();
        centerFlash("✅ Correct! +25", 900);
      }else{
        score = Math.max(0, score-5);
        centerFlash("❌ Not quite", 900);
      }
      overlay.style.display = "none";
      pausedForQuiz = false;
    };
    b.oncontextmenu = (e)=>e.preventDefault();
    answersEl.appendChild(b);
  });

  startTimer(()=>{
    score = Math.max(0, score-5);
    centerFlash("⌛ Time’s up!", 900);
    overlay.style.display = "none";
    pausedForQuiz = false;
  });
}
document.getElementById("skip").onclick = ()=>{
  clearInterval(timerId);
  overlay.style.display = "none";
  pausedForQuiz = false;
};
document.getElementById("resume").onclick = ()=>{
  clearInterval(timerId);
  overlay.style.display = "none";
  pausedForQuiz = false;
};

/* ---------- Controls / Pause / Restart ---------- */
document.getElementById("pauseBtn").onclick = ()=>{
  running = !running;
  centerFlash(running ? "▶ RESUME" : "II PAUSED", 800);
};
document.getElementById("restartBtn").onclick = reset;

function reset(){
  running = true; pausedForQuiz=false; boostTimer = 0;
  speed = 18; targetSpeed=22; maxSpeed=32; dist=0; score=0; coinsCount=0;
  correct = 0; merits = 0; hud.correct.textContent = "0"; hud.merits.textContent = "0";
  car.position.x = 0; car.position.z = 4;
  coins.forEach(c=>{ c.position.set(randX(), 0.7, -Math.random()*SEG_COUNT*SEG_LEN); });
  boosts.forEach(b=>{ b.position.set(0, 0.03, -Math.random()*SEG_COUNT*SEG_LEN); });
  obstacles.forEach(o=>{
    o.position.set(laneX(), 0.5, -Math.random()*SEG_COUNT*SEG_LEN);
    o.userData.baseX = o.position.x;
    o.userData.phase = Math.random()*Math.PI*2;
  });
  centerFlash("⟲ RESTART");
}

/* ---------- Main update loop ---------- */
function animate(now){
  requestAnimationFrame(animate);
  const dt = Math.min(0.05, (now - tPrev)/1000); // clamp delta
  tPrev = now;

  if(!running || pausedForQuiz) {
    renderer.render(scene, camera);
    return;
  }

  // inputs
  const steerLeft = keys["arrowleft"]||keys["a"];
  const steerRight= keys["arrowright"]||keys["d"];
  const boostKey  = keys[" "]||keys["arrowup"];
  const brakeKey  = keys["shift"]||keys["arrowdown"];

  if(steerLeft && !steerRight) steer = THREE.MathUtils.damp(steer, -1.0, 8, dt);
  else if(steerRight && !steerLeft) steer = THREE.MathUtils.damp(steer,  1.0, 8, dt);
  else steer = THREE.MathUtils.damp(steer, 0, 6, dt);

  if(boostKey) targetSpeed = Math.min(maxSpeed, targetSpeed + 8*dt);
  if(brakeKey) targetSpeed = Math.max(minSpeed, targetSpeed - 18*dt);
  if(boostTimer>0){ targetSpeed = Math.max(targetSpeed, maxSpeed); boostTimer -= dt; }
  speed = THREE.MathUtils.damp(speed, targetSpeed, 3, dt);

  car.position.x += steer * 6 * dt;
  car.position.x = THREE.MathUtils.clamp(car.position.x, -TRACK_WIDTH/2+0.7, TRACK_WIDTH/2-0.7);

  const moveZ = speed * dt;
  dist += moveZ;
  score = Math.floor(dist) + coinsCount*50 + Math.floor(speed*2);
  segments.forEach((g)=>{
    g.position.z += moveZ;
    if(g.position.z > SEG_LEN) g.position.z -= SEG_LEN*SEG_COUNT;
  });

  // move & recycle all scrolling elements
  const scrollers = [...laneStrips, ...coins, ...boosts, ...wallsLeft, ...wallsRight, ...floors, ...obstacles];
  scrollers.forEach(m=>{
    m.position.z += moveZ;
    if(m.userData && m.userData.type==="obstacle"){
      // lateral oscillation
      m.position.x = m.userData.baseX + Math.sin(now*0.002 + m.userData.phase)*m.userData.amp;
    }
    if(m.position.z > 10){
      // recycle behind
      let offset = SEG_LEN*SEG_COUNT;
      // widen spacing for coins so they feel rarer
      if(m.userData && m.userData.type==="coin") offset += Math.random()*30; 
      m.position.z -= offset;
      if(m.userData && m.userData.type==="coin"){ m.position.x = randX(); }
      if(m.userData && m.userData.type==="boost"){ m.position.x = 0; }
      if(m.userData && m.userData.type==="obstacle"){
        m.position.x = laneX();
        m.userData.baseX = m.position.x;
        m.userData.phase = Math.random()*Math.PI*2;
      }
    }
  });

  // wall collisions
  const edge = TRACK_WIDTH/2 - 0.8;
  if(Math.abs(car.position.x) > edge){
    targetSpeed = Math.max(minSpeed, targetSpeed - 10*dt);
    car.position.x = THREE.MathUtils.clamp(car.position.x, -edge, edge);
    centerFlash("⚡ WALL HIT – SLOW!", 300);
  }

  const carBox = carAABB();

  // coin collision -> ask question every coin
  coins.forEach(c=>{
    const box = {x:c.position.x, z:c.position.z, w:0.6, d:0.6};
    if(aabbIntersect(carBox, box)){
      coinsCount++; score += 10;
      c.position.z -= SEG_LEN*SEG_COUNT + Math.random()*30; // extra spread
      c.position.x = randX();
      showToast("🪙 Coin!");
      askQuestion();
    }
  });

  // boosts
  boosts.forEach(b=>{
    const box = {x:b.position.x, z:b.position.z, w:TRACK_WIDTH*0.7, d:1.8};
    if(aabbIntersect(carBox, box)){
      boostTimer = 3.0;
      maxSpeed = 40;
      targetSpeed = Math.max(targetSpeed, 36);
      centerFlash("🚀 BOOST +", 650);
      b.position.z -= SEG_LEN*SEG_COUNT;
    }
  });

  // obstacles — slow down and dock score
  obstacles.forEach(o=>{
    const box = {x:o.position.x, z:o.position.z, w:1.4, d:1.4};
    if(aabbIntersect(carBox, box)){
      targetSpeed = Math.max(minSpeed, targetSpeed - 16*dt - 6); // strong slow
      score = Math.max(0, score - 8);
      centerFlash("🛑 OBSTACLE!", 500);
      // knock it back a bit so we don't keep colliding this frame
      o.position.z -= 6;
    }
  });

  // camera follow
  camera.position.x = THREE.MathUtils.damp(camera.position.x, car.position.x * 0.45, 3, dt);
  camera.position.z = THREE.MathUtils.damp(camera.position.z, car.position.z + 6, 3, dt);
  camera.lookAt(car.position.x, 0.4, car.position.z - 6);

  // HUD
  hud.speed.textContent = Math.round(speed).toString();
  hud.coins.textContent = coinsCount.toString();
  hud.dist.textContent  = Math.floor(dist).toString();
  hud.score.textContent = score.toString();

  renderer.render(scene, camera);
}
reset();
requestAnimationFrame(animate);

/* ---------- Resize ---------- */
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* ---------- Prevent page scroll on mobile controls ---------- */
["left","right","boost","brake"].forEach(id=>{
  const el = document.getElementById(id);
  ["touchstart","touchmove","touchend"].forEach(ev=>{
    el.addEventListener(ev, e=>e.preventDefault(), {passive:false});
  });
});
</script>
</body>
</html>
